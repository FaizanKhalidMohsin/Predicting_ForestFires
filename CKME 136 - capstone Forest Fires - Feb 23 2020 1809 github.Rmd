---
title: "CKME 136 Capstone Forest Fires"
output:
  pdf_document: default
  html_document: default
  df_print: paged
  rows.print: 25
  word_document: default
---
1 Load packages.


```{r echo=TRUE}

#Make sure to use libraries below
library(dplyr)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("ggpubr")
library(ggpubr)
#install.packages("tidyr")
library(tidyr)
#install.packages("scales")
library(scales)
#install.packages("wesanderson")
#library(wesanderson)
#install.packages("viridis")  # Install
library("viridis")           # Load
#theme_set(theme_pubclean())
library("ggrepel")
#install.packages("janitor")
library(janitor)
#install.packages("formattable")
#library(formattable)
#install.packages("DT")
#library(DT)
#install.packages("FSelector")
#library(FSelector)
#??FSelector

```
2. Read the "fores fire .csv" file from the following website.


```{r echo=TRUE}

fires <-read.csv('CKME 136 Forest Fire Data.csv',header=T)

```

3. Have a look at the data set. View(train.data)

```{r echo=TRUE}

# Fires

head(fires)
tail(fires)
str(fires)

# Check data types of attributes
sapply(fires, class)
sapply(fires, typeof)

```
4. Extract relevant columns.


```{r echo=TRUE}

# Fires

new_fire <- fires[, c("Cause", "Jurisdiction", "Number", "Protection.zone", "Response.category", "Year")]
#new_fire

```

5. Check for missing values.

```{r echo=TRUE}

# Fire

sum(is.na(new_fire$Cause) == TRUE) # 0 Missing values.
length(new_fire$Cause)

sum(is.na(new_fire$Jurisdiction) == TRUE) # 0 Missing values.
length(new_fire$Jurisdiction)

sum(is.na(new_fire$Number) == TRUE) # 8352 initial missing values for "Number" field. 
length(new_fire$Number)

sum(is.na(new_fire$Protection.zone) == TRUE) # 0 Missing values.
length(new_fire$Protection.zone)

sum(is.na(new_fire$Response.category) == TRUE) # 0 Missing values.
length(new_fire$Response.category)

sum(is.na(new_fire$Year) == TRUE) # 0 Missing values.
length(new_fire$Year)

```

6. Only "Number" has missing rows.  Remove all rows with missing values.


```{r echo=TRUE}

# Fires

# Remove remaining records with missing values.
FireClean <- new_fire[complete.cases(new_fire),]

nrow(FireClean) #11519 rows remaining

```

7. Check attributes after missing rows have been removed.


```{r echo=TRUE}

# Fire

attach(FireClean)

head(FireClean)
tail(FireClean)
str(FireClean)
dim(FireClean) # 11519 rows, 6 columns

# Check data types of attributes
sapply(FireClean, class)


levels(FireClean$Cause)
levels(FireClean$Jurisdiction)
levels(FireClean$Protection.zone)
levels(FireClean$Response.category)
levels(FireClean$Year)
summary(FireClean) # Only the "number" attribute maybe usefull with the summary

```

8. Shorten "Jurisdiction" name

```{r echo=TRUE}

FireClean$Juris_Long <- FireClean$Jurisdiction # Duplicate Jurisdiction column

levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "British Columbia"] <- "BC"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Alberta"] <- "AB"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "National parks"] <- "NP"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Northwest Territories"] <- "NT"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Prince Edward Island"] <- "PE"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Yukon"] <- "YT"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "New Brunswick"] <- "NB"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Nova Scotia"] <- "NS"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Quebec"] <- "QC"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Manitoba"] <- "MB"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Newfoundland and Labrador"] <- "NL"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Ontario"] <- "ON"
levels(FireClean$Jurisdiction)[levels(FireClean$Jurisdiction) == "Saskatchewan"] <- "SK"
levels(FireClean$Jurisdiction)

```
9. create new column: Cause_Grouped  People vs Lightning

```{r echo=TRUE}

FireClean <- FireClean %>%
  mutate(Cause_Grouped = case_when(
    Cause == "Lightning"  ~ "Lightning",
    TRUE                 ~ "People"
    )
  )

```
10. Create new column: Time1   Group Years

```{r echo=TRUE}

FireClean <- FireClean %>%
  mutate(Time1 = case_when(
    Year <= 1995                 ~ "Early 90s",
    Year >= 1996 & Year <= 2000  ~ "Late 90s",
    Year >= 2001 & Year <= 2005  ~ "Early 10s",
    Year >= 2006 & Year <= 2010  ~ "Late 10s",
    Year >= 2011 & Year <= 2015  ~ "Early 20s",
    Year >= 2016                 ~ "Late 20s"
    )
  )

```
11. Create new column: Time2   Group Years

```{r echo=TRUE}

FireClean <- FireClean %>%
  mutate(Time2 = case_when(
    Year >= 1990 & Year <= 1999  ~ "1990s",
    Year >= 2000 & Year <= 2009  ~ "2000s",
    Year >= 2010 & Year <= 2018  ~ "2010s"
    )
  )

```
12. Group Provinces into regions

```{r echo=TRUE}

FireClean <- FireClean %>% 
  mutate(Region = case_when(
    Jurisdiction %in% c("AB", "MB", "SK")           ~ "Prairie Region",
    Jurisdiction %in% c("BC")                       ~ "Pacific Region",
    Jurisdiction %in% c("NP")                       ~ "National Parks",
    Jurisdiction %in% c("NB", "NL", "NS", "PE")     ~ "Atlantic Region",
    Jurisdiction %in% c("ON", "QC")                 ~ "Central Region",
    Jurisdiction %in% c("YT", "NT")                 ~ "North Region"
      )
  )

```

13. Check structure of attributes again.

```{r echo=TRUE}

attach(FireClean)

head(FireClean)
tail(FireClean)
str(FireClean)
dim(FireClean) # 11519 rows, 6 columns

# Check data types of attributes
sapply(FireClean, class)

levels(FireClean$Cause)
levels(FireClean$Jurisdiction)
levels(FireClean$Protection.zone)
levels(FireClean$Response.category)
levels(FireClean$Year)
summary(FireClean) # Only the "number" attribute maybe usefull with the summary
summary(FireClean$Number) 
summary(FireClean$Year) 

```

14. Visulization, Barplot, Boxplot

```{r echo=TRUE, rows.print=30, cols.print=30}

data <- tbl_df(FireClean)

head(data)

########################################################################################################################################
#11 

pivot3 <- data %>%
select(Year, Number, Cause_Grouped)
head(pivot3)


pivot3 <- data %>% #Groups Cause together and sums Number
  select(Cause_Grouped, Number, Year, Jurisdiction) %>% 
  filter(Jurisdiction == "BC") %>% 
  group_by(Year, Cause_Grouped) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  

pivot3 %>% 
  spread(Year, sum_Number)

############
#SUMMING COLUMNS AND ROWS
pivot4 <- pivot3 %>% 
  spread(Year, sum_Number)

pivot4

pivot5 <- pivot4 %>%
  adorn_totals("row") %>% 
  adorn_totals("col") 

pivot5

##################################################
# Test 1
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3, aes(x = Year,
                               y = sum_Number,
                               color = Cause_Grouped)
            ) +
  geom_bar(stat="identity", width = 0.7, fill="white") +
  # geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
  #                 vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  scale_x_continuous(breaks=1990:2018)+
  #stat_summary(fun.y = sum, aes(label = ..y.., group = Year), geom = "text", vjust= -1.5, show_guide = F)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 5000))+
  labs(title = "Causes of Forest Fires in BC (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 0 ,size = 9, angle = 90))

########################################################################################################################################
#10-B Practice sum column and rows

pivot3 <- data %>%
select(Region, Number, Cause_Grouped)
head(pivot3)

# attach(pivot3)
# detach(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Region, Number, Cause_Grouped) %>% 
  group_by(Cause_Grouped, Region) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE))
  
pivot3 %>% 
  spread(Cause_Grouped, sum_Number)

############
#SUMMING COLUMNS AND ROWS
pivot4 <- pivot3 %>% 
  spread(Cause_Grouped, sum_Number)

pivot4

pivot5 <- pivot4 %>%
  adorn_totals("row") %>% 
  adorn_totals("col") 

pivot5

##################################################
#CORRELATION USE FOR pivot3 ONLY
CorDataFrame <- pivot3 %>% 
  spread(Cause_Grouped, sum_Number)

CorDataFrame
sapply(CorDataFrame, is.numeric) # Which columns are numeric?

my_num_data <- CorDataFrame[, sapply(CorDataFrame, is.numeric)] # Subset numeric columns
my_num_data


plot(my_num_data) # Works
cor(my_num_data)


##################################################

# Test 1
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3,
       aes(x = Region, y = sum_Number, color=Cause_Grouped)) +
  geom_bar(position = "dodge", stat="identity", width = 0.7, fill="white") +
  geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
                  vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 40000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 1,size = 9, angle = 45))



########################################################################################################################################
#10 

pivot3 <- data %>%
select(Region, Number, Cause_Grouped)
head(pivot3)

# attach(pivot3)
# detach(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Region, Number, Cause_Grouped) %>% 
  group_by(Cause_Grouped, Region) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  

pivot3 %>% 
  spread(Cause_Grouped, sum_Number)


##################################################
#CORRELATION
CorDataFrame <- pivot3 %>% 
  spread(Cause_Grouped, sum_Number)

CorDataFrame
sapply(CorDataFrame, is.numeric) # Which columns are numeric?

my_num_data <- CorDataFrame[, sapply(CorDataFrame, is.numeric)] # Subset numeric columns
my_num_data


plot(my_num_data) # Works
cor(my_num_data)


##################################################

# Test 1
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3,
       aes(x = Region, y = sum_Number, color=Cause_Grouped)) +
  geom_bar(position = "dodge", stat="identity", width = 0.7, fill="white") +
  geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
                  vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 40000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 1,size = 9, angle = 45))

########################################################################################################################################
#9

pivot3 <- data %>%
select(Year, Number, Jurisdiction)
head(pivot3)


pivot3 <- data %>% #Groups Cause together and sums Number
  select(Jurisdiction, Number, Year) %>% 
  group_by(Year, Jurisdiction) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  

pivot3 %>% 
  spread(Year, sum_Number)

#Produces matrix with zero
pivot4 <- pivot3 %>% 
  spread(Year, sum_Number)

pivot4

#Remove NAs from matrix, replace with zero
pivot4[is.na(pivot4)] <- 0
#Matrix now has NAs removed, now replaced with zero
pivot4

############
#SUMMING COLUMNS AND ROWS

pivot5 <- pivot4 %>%
  adorn_totals("row") %>% 
  adorn_totals("col") 

pivot5

##################################################
# Test 4
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3, aes(x = Year,
                               y = sum_Number,
                               color = Jurisdiction)
            ) +
  geom_line(stat="identity", width = 0.7, fill="white", size = 2) +
  # geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
  #                 vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7",
                                "#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442")) +
  scale_x_continuous(breaks=1990:2018)+
  #stat_summary(fun.y = sum, aes(label = ..y.., group = Year), geom = "text", vjust= -1.5, show_guide = F)+
  xlab("Year") +
  ylab("Number of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 4500))+
  labs(title = "Number of Forest Fires for each Province (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 0 ,size = 9, angle = 90))


##################################################
# Test 3
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3, aes(x = Year,
                               y = sum_Number,
                               color = Jurisdiction)
            ) +
  geom_line(stat="identity", width = 0.7, fill="white", size = 2) +
  # geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
  #                 vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  scale_x_continuous(breaks=1990:2018)+
  #stat_summary(fun.y = sum, aes(label = ..y.., group = Year), geom = "text", vjust= -1.5, show_guide = F)+
  xlab("Year") +
  ylab("Number of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 4500))+
  labs(title = "Number of Forest Fires for each Province (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 0 ,size = 9, angle = 90))


##################################################
# Test 2
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3, aes(x = Year,
                               y = sum_Number,
                               color = Jurisdiction)
            ) +
  geom_line(stat="identity", width = 0.7, fill="white") +
  # geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
  #                 vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  scale_x_continuous(breaks=1990:2018)+
  #stat_summary(fun.y = sum, aes(label = ..y.., group = Year), geom = "text", vjust= -1.5, show_guide = F)+
  xlab("Year") +
  ylab("Number of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 4500))+
  labs(title = "Number of Forest Fires for each Province (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 0 ,size = 9, angle = 90))


########################################################################################################################################
#8

pivot3 <- data %>%
select(Year, Number, Cause_Grouped)
head(pivot3)


pivot3 <- data %>% #Groups Cause together and sums Number
  select(Cause_Grouped, Number, Year) %>% 
  group_by(Year, Cause_Grouped) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  

pivot3 %>% 
  spread(Year, sum_Number)

##################################################
# Test 8
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3, aes(x = Year,
                               y = sum_Number,
                               color = Cause_Grouped)
            ) +
  geom_bar(stat="identity", width = 0.7, fill="white") +
  # geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
  #                 vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  scale_x_continuous(breaks=1990:2018)+
  #stat_summary(fun.y = sum, aes(label = ..y.., group = Year), geom = "text", vjust= -1.5, show_guide = F)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 12000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 0 ,size = 9, angle = 90))


########################################################################################################################################
#7

pivot3 <- data %>%
select(Jurisdiction, Number, Year)
head(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Jurisdiction, Number, Year) %>% 
  group_by(Year, Jurisdiction) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  
#Produces matrix with zero
pivot4 <- pivot3 %>% 
  spread(Year, sum_Number)

pivot4

#Remove NAs from matrix, replace with zero
pivot4[is.na(pivot4)] <- 0
#Matrix now has NAs removed, now replaced with zero
pivot4

############
#SUMMING COLUMNS AND ROWS

pivot5 <- pivot4 %>%
  adorn_totals("row") %>% 
  adorn_totals("col") 

pivot5

##################################################

boxplot(sum_Number~Year,
  data=pivot3,
  main="Distribution of number of fires for all Provinces per year \n(1990 - 2018)",
  xlab="Year",
  ylab="Number of Fires",
  col=c("blue", "indianred1","red","orange","purple","green",
    "pink","brown", "mediumpurple2","olivedrab1"),
  border="black"
)


########################################################################################################################################
#6 Boxplot
pivot3 <- data %>%
select(Jurisdiction, Number, Year)
head(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Jurisdiction, Number, Year) %>% 
  group_by(Year, Jurisdiction) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  

pivot3 %>% 
  spread(Jurisdiction, sum_Number)

#Produces matrix with zero
pivot4 <- pivot3 %>% 
  spread(Jurisdiction, sum_Number)

pivot4

#Remove NAs from matrix, replace with zero
pivot4[is.na(pivot4)] <- 0
#Matrix now has NAs removed, now replaced with zero
pivot4

############
#SUMMING COLUMNS AND ROWS

pivot5 <- pivot4 %>%
  adorn_totals("row") %>% 
  adorn_totals("col") 

pivot5

##################################################


##################################################
#CORRELATION
CorDataFrame <- pivot3 %>% 
  spread(Jurisdiction, sum_Number)


CorDataFrame
sapply(CorDataFrame, is.numeric) # Which columns are numeric?

my_num_data <- CorDataFrame[, sapply(CorDataFrame, is.numeric)] # Subset numeric columns
my_num_data


plot(my_num_data) # Works
cor(my_num_data)

##################################################
# Test 1

boxplot(sum_Number~Jurisdiction,
  data=pivot3,
  main="Distribution of number of fires in each Province per year \n(1990 - 2018)",
  xlab="Provinces",
  ylab="Number of Fires",
  col=c("blue", "indianred1","red","orange","purple","green",
    "pink","brown", "mediumpurple2","olivedrab1"),
  border="black"
)

##################################################

########################################################################################################################################
#5 Boxplot

pivot3 <- data %>%
select(Jurisdiction, Number, Cause_Grouped)
head(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Jurisdiction, Number, Cause_Grouped) %>% 
  group_by(Cause_Grouped, Jurisdiction) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  
pivot3 %>% 
  spread(Cause_Grouped, sum_Number)



##################################################

# Test 2
  

boxplot(sum_Number~Cause_Grouped,
  data=pivot3,
  main="Distribution of number of fires in each Province for each cause \n(1990 - 2018)",
  xlab="Cause",
  ylab="Number of Fires",
  col=c("blue", "indianred1","red","orange","purple","green",
    "pink","brown", "mediumpurple2","olivedrab1"),
  border="black"
)

########################################################################################################################################
#4

pivot3 <- data %>%
select(Jurisdiction, Number, Cause_Grouped)
head(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Jurisdiction, Number, Cause_Grouped) %>% 
  group_by(Cause_Grouped, Jurisdiction) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  
pivot3 %>% 
  spread(Cause_Grouped, sum_Number)


##################################################
# Test 5
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3, aes(x = Jurisdiction,
                               y = sum_Number,
                               color = Cause_Grouped)
            ) +
  geom_bar(stat="identity", width = 0.7, fill="white") +
  # geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
  #                 vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  stat_summary(fun.y = sum, aes(label = ..y.., group = Jurisdiction), geom = "text", vjust= -1.5, show_guide = F)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 60000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 1,size = 9, angle = 0))


########################################################################################################################################
#3
pivot3 <- data %>%
select(Jurisdiction, Number, Cause_Grouped)
head(pivot3)

# attach(pivot3)
# detach(pivot3)

pivot3 <- data %>% #Groups Cause together and sums Number
  select(Jurisdiction, Number, Cause_Grouped) %>% 
  group_by(Cause_Grouped, Jurisdiction) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE)) 
  
pivot3 %>% 
  spread(Cause_Grouped, sum_Number)


##################################################
#CORRELATION
CorDataFrame <- pivot3 %>% 
  spread(Cause_Grouped, sum_Number)

CorDataFrame
sapply(CorDataFrame, is.numeric) # Which columns are numeric?

my_num_data <- CorDataFrame[, sapply(CorDataFrame, is.numeric)] # Subset numeric columns
my_num_data


plot(my_num_data) # Works
cor(my_num_data)


##################################################

# Test 11
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }


p <- ggplot(data = pivot3,
       aes(x = Jurisdiction, y = sum_Number, color=Cause_Grouped)) +
  geom_bar(position = "dodge", stat="identity", width = 0.7, fill="white") +
  geom_text_repel(aes(label=sum_Number), show_guide = F, position=position_dodge(width=0.4),
                  vjust= -2.4, hjust = 0.4, size = 3.8, angle = 0)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 40000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 1,size = 9, angle = 0))

########################################################################################################################################
#2
#Below works with percentage totals
GCause_HvsL <- data %>% #Groups Cause together and sums Number
  group_by(Cause_Grouped) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE)) %>% 
  mutate(rel.freq = paste0(round(100 * sum_Number/sum(sum_Number),0),"%"))

GCause_HvsL

##################################################

# Boxplot GCause 11, testing
  
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }

p <- ggplot(data = GCause_HvsL,
       aes(x = Cause_Grouped, y = sum_Number, color=Cause_Grouped)) +
  geom_bar(stat="identity", width = 0.3, fill="white") +
  geom_text(aes(label=sum_Number), position=position_dodge(width=0.9), vjust=-0.15)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 125000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 1,size = 9, angle = 45), legend.position = "none")

########################################################################################################################################
#1
#Below works with percentage totals
GCause <- data %>% #Groups Cause together and sums Number
  group_by(Cause) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE)) %>% 
  mutate(rel.freq = paste0(round(100 * sum_Number/sum(sum_Number),0),"%"))

GCause

##################################################

ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }

p <- ggplot(data = GCause,
       aes(x = Cause, y = sum_Number, color=Cause)) +
  geom_bar(stat="identity", fill="white") +
  geom_text(aes(label=sum_Number), position=position_dodge(width=0.9), vjust=-0.15)+
  xlab("Cause") +
  ylab("Causes of Forest Fires (1990 - 2018)") +
  scale_y_continuous(name="Sum of Forest Fires", labels = ks)+
  coord_cartesian(ylim = c(0, 105000))+
  labs(title = "Causes of Forest Fires (1990 - 2018)")

p
p + theme(
  axis.text.x = element_text(face = "bold", color = "#993333", hjust = 1,size = 9, angle = 45), legend.position = "none")

########################################################################################################################################

#Sample code for various statistics
data %>% #Groups Cause, Year together and sums Number
  group_by(Cause, Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))    

#Below code works
data %>% #Groups Cause, Year together and sums Number
  group_by(Cause, Jurisdiction, Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))    

#Below code works
data %>% #Groups Cause, Year together and sums Number
  group_by(Jurisdiction, Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))    

#Below code works
data %>% #Groups Cause, Year together and sums Number
  group_by(Year, Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))    

#Below code works
data %>% #Groups Cause, Year together and sums Number
  group_by(Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))    

#Below code works
data %>% #Groups Cause, Year together and sums Number
  group_by(Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))    

#######################################################
#Below code works
data %>% #Groups Cause, Year, Jurisdiction and sums Number
  group_by(Cause, Year, Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE)) %>% 
  filter(Jurisdiction == "BC") %>%
  filter(Cause == "Lightning")

#Below code works
data %>% #Groups Cause together and sums Number
  group_by(Cause, Year, Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE)) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning")

#Below works great, show max number of fires and year for Alberta
data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  top_n(n=1) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning") 

#Below works great, Top 10 years for Lightning in Alberta
data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  top_n(n=10) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning") %>% 
  arrange(desc(max_Number))

#Below works great, Top 10 years for Lightning in Alberta
data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  top_n(n=10) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning")
  
#Below works great, Top 10 years for Lightning in Alberta
Alberta <- data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  top_n(n=10) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning")

Alberta

hist(Alberta$Year)
hist(Alberta$max_Number)

#Below works
data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning") %>% 
  filter(Year > "2003")
  
#Below works, Top 10 after 2003
data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning") %>% 
  filter(Year > "2003") %>% 
  arrange(desc(max_Number))

data %>% 
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))


#Below works, Top 10 after 2003
data %>% #Groups Cause together and sums Number
  group_by(Jurisdiction, Cause, Year) %>% 
  summarize(max_Number = max(Number, na.rm = TRUE)) %>% 
  filter(Jurisdiction == "AB") %>%
  filter(Cause == "Lightning") %>% 
  filter(Year > "2003") %>% 
  arrange(desc(max_Number))

################################################

data %>% #Groups Cause together and sums Number.  Also provides avg for Number of fires.
  group_by(Cause) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE),
    count = n(),
    average_fire = mean(Number, na.rm = TRUE))

data %>% #Groups Cause together and sums Number.  Also provides avg for Number of fires.
  group_by(Cause) %>% 
  summarize(
    sum_Number = sum(Number, na.rm = TRUE),
    count = n(),
    average_fire = mean(Number, na.rm = TRUE),
    total = sum(sum_Number)
    )

data %>% #Groups Year and sums Number
  group_by(Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))

data %>% #Groups Jurisdiction and sums Number
  group_by(Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))

data %>% 
  group_by(Year) %>%
  group_by(Jurisdiction) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))

data %>% 
  group_by(Jurisdiction) %>%
  group_by(Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))

data %>% 
  group_by(Jurisdiction) %>%
  group_by(Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))

data %>% 
  group_by(Jurisdiction) %>%
  group_by(Year) %>% 
  summarize(sum_Number = sum(Number, na.rm = TRUE))

data %>% 
  group_by(Jurisdiction, Cause, Year) %>%
  summarize(sum_Number = sum(Number, na.rm = TRUE))

###################


```




# Modeling 

## Model 1: Linear Regression for Predicting Forest Fires. 

```{r}

# Create total forest fires per year variable. 
require(dplyr)

print(unique(data[, 1]))

data$Fire_Cause_Human = as.character(data$Cause)


data$Fire_Cause_Human[ data$Fire_Cause_Human != "Lightning" & data$Fire_Cause_Human != "Unspecified" ] = "Human"

unique(data$Fire_Cause_Human)


names(data)
unique(data$Cause_Grouped)
unique(data$Year)

# Model time series for each province. 



# Model time series for human, and non-human cause. 

fm1 = Number ~ Juris_Long + Year + Fire_Cause_Human  + Response.category
model1 = lm(fm1, data = data)
model1 = lm(Number ~ Juris_Long + Year + Fire_Cause_Human + Protection.zone + Response.category, data = data)

summary(model1)

```





```{r}

#Prediction for year 2018

data2018 = filter(data, Year == 2018)
datarm2018 = filter(data, Year != 2018)

modelrm2018 = lm(fm1, data = datarm2018)
summary(modelrm2018)



number_predict_2018 = predict(modelrm2018, newdata = select(data2018, Juris_Long, Year, Fire_Cause_Human, Response.category), type = "response" )
length(number_predict_2018)
length(data2018$Number)
plot(data2018$Number, number_predict_2018)

# The MSE of the model. 
mean((number_predict_2018  - data2018$Number)^2)


```

### Prediction for Year 2017

```{r}


yr1 = 2018

dim(filter(data, Year == yr1))

# Function that calculates the mse for the year specified. The mse is calculated as the number of predicted fires minus the actual number of fires in that year and taking the squared mean of the differnce. 

rmse_year_function = function(datta, year, model_formula = Number ~ Juris_Long + Year + Fire_Cause_Human  + Response.category ) {
  
    data_test = filter(datta, Year == year)
    data_train = filter(datta, Year < year)
    
    model = lm( model_formula, data = data_train   )
    
    RMSE = sqrt(mean((predict(model, newdata = select(data_test, Juris_Long, Year, Fire_Cause_Human, Response.category)) - data_test$Number)^2) )
  
    return(data.frame( Year = year, RMSE = RMSE))
  
}
 
rmse_year_function(datta = data, year = 2018) 

rmse_year_function(datta = data, year = 2017) 

rmse_year_function(datta = data, year = 2016) 

```

# Include Provincial Data

```{r}

require(readxl)
require(dplyr)
require(stringr)

data_initial = data
str(data)
data$Juris_Long = as.character(data$Juris_Long)
pdata = read_excel("ProvinceData.xlsx", sheet = 1)
pdataf = pdata[,c(1,2,4,5)]
pdataf$perc_of_forest_area = pdataf$`Total forest area (km²)`/ pdataf$`Land area (km²)`
pdataf$Juris_Long = str_trim(pdataf$Juris_Long)
str(pdataf)
unique(pdataf$Juris_Long)
unique(data$Juris_Long)
dataf = left_join(data, pdataf)
colnames(pdataf)
colnames(dataf)
dataf$perc_of_forest_area_normalized = ( dataf$perc_of_forest_area - mean(dataf$perc_of_forest_area))/ sd(dataf$perc_of_forest_area)

dataf$total_forest_area_normalized = ( dataf$`Total forest area (km²)` - mean(dataf$`Total forest area (km²)`))/ sd(dataf$`Total forest area (km²)`)


str(dataf)
write.csv(dataf, "cleaned_data_final")

```




```{r}
rmse_year_function2 = function(datta, year, model_formula = Number ~ Juris_Long + Year + Fire_Cause_Human  + Response.category + perc_of_forest_area_normalized) {
    #datta = dataf
    #year = 2018
    data_test = filter(datta, Year == year)
    data_train = filter(datta, Year < year)
    
    model = lm( model_formula, data = data_train   )
    #summary(model)
    #length(model$coefficients) > model$rank
    RMSE = sqrt(mean((predict(model, newdata = select(data_test, Juris_Long, Year, Fire_Cause_Human, Response.category, perc_of_forest_area_normalized)) - data_test$Number)^2) )
  
    return(data.frame( Year = year, RMSE = RMSE))
  
}

rmse_year_function3 = function(datta, year, model_formula = Number ~ Juris_Long + Year + Fire_Cause_Human  + Response.category + total_forest_area_normalized) {
    datta = dataf
    year = 2018
    data_test = filter(datta, Year == year)
    data_train = filter(datta, Year < year)
    
    model = lm( model_formula, data = data_train   )
    summary(model)
    length(model$coefficients) > model$rank
    RMSE = sqrt(mean((predict(model, newdata = select(data_test, Juris_Long, Year, Fire_Cause_Human, Response.category, total_forest_area_normalized)) - data_test$Number)^2) )
  
    return(data.frame( Year = year, RMSE = RMSE))
  
}



rmse_year_function4 = function(datta, year, model_formula = Number ~ Juris_Long + Year + Fire_Cause_Human  + Response.category ) {
    datta = dataf
    year = 2018
    data_test = filter(datta, Year == year)
    data_train = filter(datta, Year < year)
    
    model = lm( model_formula, data = data_train   )
    summary(model)
    #length(model$coefficients) > model$rank
    RMSE = sqrt(mean((predict(model, newdata = select(data_test, Juris_Long, Year, Fire_Cause_Human, Response.category)) - data_test$Number)^2) )
  
    return(data.frame( Year = year, RMSE = RMSE))
  
}


```



```{r}

unique(filter(dataf, Year == 2016)$Juris_Long)
rmse_year_function2(datta = dataf, year = 2016)
rmse_year_function(datta = data, year = 2016)

```


```{r}
# dim(dataf)
# merge_fun = function(province = "Alberta",dataf = dataf, pdataf = pdataf ){
#   ind = which(dataf$Juris_Long == "Alberta")
#   dataf[ind, 15-2] = pdataf[pdataf$Juris_Long == province, 2]
#   dataf[ind, 15-1] = pdataf[pdataf$Juris_Long == province, 3]
#   dataf[ind, 15] = pdataf[pdataf$Juris_Long == province, 4]
# }
# 
# pdataf$Juris_Long == "Alberta"
# trimws(unique(pdataf$Juris_Long), which ="both")
# 
# merge_fun()
# 
# print(colnames(pdataf))
```


## Model 2: Time Series Analysis.



```{r}

require(tidyverse)
require(tidymodels)
require(data.table)
require(tidyposterior)
require(tsibble)  #tsibble for time series based on tidy principles
require(fable)  #for forecasting based on tidy principles
require(ggfortify)  #for plotting timeseries
require(forecast)  #for forecast function
require(tseries)
require(chron)
require(lubridate)
require(directlabels)
require(zoo)

```

```{r}

time_s = data %>% group_by(Year) %>% summarise(tot_fires = sum(Number))

plot(time_s)

length(unique(data$Year))

time_s_alberta = subset(data, Juris_Long == "Alberta")
head(time_s_alberta)

```


```{r}
 
time_s$y = time_s$tot_fires
time_series_data = time_s
y = "Number of Total Fires"

y_time_series = time_series_data$y


#ts_total = ts(y_time_series, start = 1990, end = 2018, frequency = 1)
ts_total = ts(y_time_series, start = 1990, frequency = 1)
str(ts_total)

plot(ts_total)
```

```{r}

plot(decompose(ts_total))

```


```{r}

# Directly plotting a forecast of a model
plot(forecast(auto.arima(ts_total)))

```


In time series analysis, an autoregressive integrated moving average (ARIMA) model is a generalization of an autoregressive moving average (ARMA) model. Both of these models are fitted to time series data either to better understand the data or to predict future points in the series (forecasting). ARIMA models are applied in some cases where data show evidence of non-stationarity, where an initial differencing step (corresponding to the "integrated" part of the model) can be applied one or more times to eliminate the non-stationarity.[1]

The AR part of ARIMA indicates that the evolving variable of interest is regressed on its own lagged (i.e., prior) values. The MA part indicates that the regression error is actually a linear combination of error terms whose values occurred contemporaneously and at various times in the past. The I (for "integrated") indicates that the data values have been replaced with the difference between their values and the previous values (and this differencing process may have been performed more than once). The purpose of each of these features is to make the model fit the data as well as possible.

Non-seasonal ARIMA models are generally denoted ARIMA(p,d,q) where parameters p, d, and q are non-negative integers, p is the order (number of time lags) of the autoregressive model, d is the degree of differencing (the number of times the data have had past values subtracted), and q is the order of the moving-average model. Seasonal ARIMA models are usually denoted ARIMA(p,d,q)(P,D,Q)m, where m refers to the number of periods in each season, and the uppercase P,D,Q refer to the autoregressive, differencing, and moving average terms for the seasonal part of the ARIMA model.[2][3]

When two out of the three terms are zeros, the model may be referred to based on the non-zero parameter, dropping "AR", "I" or "MA" from the acronym describing the model. For example, ARIMA (1,0,0) is AR(1), ARIMA(0,1,0) is I(1), and ARIMA(0,0,1) is MA(1).

```{r}

```


# Analysis of Stationarity

## Autocorrelation function (ACF) of the time series


```{r}
acf(time_series_data$y, main = paste("ACF of", y))  #Autocorrelation (lags outside 95% confidence bands) implies stochastic or deterministic trend
```

## Plot of the differenced time series

```{r}
diff_y_time_series = diff(log(y_time_series))
plot(diff_y_time_series, type = "line", main = paste('Differenced ', y))  #Visual proof of weakly stationary mean and variance 
```


## Autocorrelation function (ACF) of the differenced time series

```{r}


acf(na.omit(diff_y_time_series), main = paste('ACF of Differenced', y))  #Lags within the 95% confidence bands are considered noise and are statistically insignificant (trend removed). Lags outside 95% confidence bands determine the order of the MA(q) process -- an MA process of the order q has an ACF that cuts off after q lags.
```


## Partial autocorrelation function (PACF) of the differenced time series

```{r}
pacf(na.omit(diff_y_time_series), main = paste('PACF of Differenced', y))  #Lags within the 95% confidence bands are considered noise and are statistically insignificant (trend removed). Lags outside 95% confidence bands determine the order of the AR(p) process -- an AR process of the order p has a PACF that cuts off after p lags.
```


## Ljung-Box test of autocorrelation

```{r}
Box.test(diff_y_time_series, lag = log(length(diff_y_time_series)), type = "Ljung-Box")  #Formal test of autocorrelation and/or associated trend. The null hypothesis is that there is no autocorrelation (confirmed by p-value > 5%)
```

## Augmented Dickey-Fuller test of stationarity

```{r}
library(tseries)
adf.test(na.omit(diff_y_time_series))  #Formal test of stationarity. The null hypothesis is that the process is NOT stationary.  We look for a p-value < 5% to reject the null hypothesis in favor of the alternative hypothesis (in which case the process is stationary)
```




### Automated Time series forecast for each province and for each cause of fire. 

```{r}


plot(time_s)


unique(data$Fire_Cause_Human)

ts_forecast_cov = function(data, covariate , subset = "Province" ) {
  
  # Subset = "Cause" or "Province"
  # Covariate = "Human", "Lightning","Unspecified" or one of the Provinces. 
  
  
  if (subset == "Cause"){
    
    time_s = subset(data,Fire_Cause_Human == covariate)  %>% group_by(Year) %>% summarise(tot_fires = sum(Number))
    
  } else {
    
    time_s = subset(data, Juris_Long == covariate)  %>% group_by(Year) %>% summarise(tot_fires = sum(Number))
    
  }
  
  y_time_series = time_s$tot_fires
  
  ts_total = ts(y_time_series, start = 1990, frequency = 1)
  
  plot(forecast(auto.arima(ts_total)))
  
}
  
#y = "Number of Total Fires"


ts_forecast_cov(data, covariate = "Alberta", subset = "Province" )
ts_forecast_cov(data, covariate = "Ontario", subset = "Province" )
ts_forecast_cov(data, covariate = "Quebec", subset = "Province" )
ts_forecast_cov(data, covariate = "Human", subset = "Cause" )
ts_forecast_cov(data, covariate = "Lightning", subset = "Cause" )


```


## Model 3: Random Forest Regression. 




## Model 4: Poisson Regression for Time Series Data (GLARMA)


# # INRA model.


```{r}
install.packages("glarma")


```







.Misc code to be entered.

```{r echo=TRUE}


```


